services:
  redis:
    # Redis instance for caching and session management
    image: redis:7-alpine
    container_name: ai-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - /mnt/ai/redis:/data

  searxng:
    # Web search engine using SearXNG for information retrieval
    image: searxng/searxng:latest
    container_name: ai-searxng
    restart: unless-stopped
    ports:
      - "8088:8080"
    environment:
      - BASE_URL=http://localhost:8088/
    volumes:
      - /mnt/ai/searxng:/etc/searxng
      - /mnt/ai/searxng/settings.yml:/etc/searxng/settings.yml:ro

  tts:
    # Text-to-Speech service using OpenedAI-Speech
    image: ghcr.io/matatonic/openedai-speech:latest
    container_name: ai-tts
    restart: unless-stopped
    ports:
      - "8001:8000"
    volumes:
      - /mnt/ai/tts/voices:/app/voices
      - /mnt/ai/tts/config:/app/config

  open-webui:
    # Main UI and user system for interacting with LLMs, images, and other services
    image: ghcr.io/open-webui/open-webui:main
    container_name: ai-openwebui
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Native Ollama on the VM host
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      # Web search via SearXNG (self-hosted)
      - ENABLE_WEB_SEARCH=true
      - WEB_SEARCH_ENGINE=searxng
      - SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>&format=json
      - ENABLE_RAG_WEB_SEARCH=true
      - WEB_SEARCH_RESULT_LIMIT=5
      - WEB_SEARCH_TIMEOUT=12
      # WebUI URL (accessing over HTTPS via Cloudflare Tunnel)
      - WEBUI_URL=https://ai.YOUR.DOMAIN  # Necessary for TTS to work over HTTPS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - searxng
      - tts
    volumes:
      - /mnt/ai/openwebui:/app/backend/data

  comfyui:
    # Image generation service using ComfyUI
    image: yanwk/comfyui-boot:cu124-slim
    container_name: ai-comfyui
    restart: unless-stopped
    ports:
      - "8188:8188"
    volumes:
      - /mnt/ai/comfyui/root:/root
    environment:
      - CLI_ARGS=--listen 0.0.0.0 --port 8188
    gpus: all